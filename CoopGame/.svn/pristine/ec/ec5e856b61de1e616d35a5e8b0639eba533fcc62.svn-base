#' @name banzhafValue
#' @title banzhafValue
#' @description banzhafIndex computes the Banzhaf Index given either a game vector (A) or a coalition function as input. \cr
#'              The Banzhaf value itself is an alternative to the Shapley value. \cr
#'              Conceptually, the Banzhaf value is very similar to the Shapley value. \cr 
#'              Its main difference from the Shapley value is that the Banzhaf Value is coalition\cr
#'              based rather than permutation based. Hence the factors by which we multiply the marginal contributions. \cr
#'              Shapley factor: \eqn{((k-1)!*(n-k))}\cr
#'              Banzhaf factor: \eqn{(1/(2^(n-1))} 
#'
#' @aliases banzhafValue
#' @export banzhafValue
#' @template author/JA
#' @template author/JS
#' @template cites/PETERS_2015
#' @templateVar PETERS_2015_P pp. 367
#' @template cites/CHAKRAVARTY_ET_AL_2015
#' @templateVar CHAKRAVARTY_ET_AL_2015_P p. 118 f.
#' @inheritParams CoopGameBaseParams 
#' @template param/test
#' @return The return value is a vector which contains the Banzhaf value for each player.
#' @examples
#' banzhafValue(cFuncQuotaVector(n=3,w=c(50,30,20),q=67))
#' #[1] 0.6 0.2 0.2
banzhafValue<-function(A){
  bv=BanzhafConcept(A)
  return(calculatePowerIndex(bv))
}

#' @name banzhafIndex
#' @title banzhafIndex
#' @description banzhafIndex
#' @aliases banzhafIndex
#' @export banzhafIndex
#' @template author/JA
#' @template author/JS
#' @template cites/PETERS_2015
#' @templateVar PETERS_2015_P p. 367 ff.
#' @template cites/CHAKRAVARTY_ET_AL_2015
#' @templateVar CHAKRAVARTY_ET_AL_2015_P p. 118 f.
#' @inheritParams CoopGameBaseParams
#' @return The return value is a vector which contains the Banzhaf index for each player.
#' @examples 
#' A<- cFuncApexVector(n = 4,apexPlayer=3)
#' banzhafIndex(A=A)
#' 
#' #N=c(1,2,3), w=(50,49,1), q=51   
#' A=cFuncQuotaVector(n=3, w=c(50,49,1),q=51)
#' banzhafIndex(A)
#' #[1] 0.6 0.2 0.2
#' 
#' A<-cFuncQuotaVector(n=3,w=c(50,30,20),q=c(67))
#' banzhafIndex(A)
#' #[1] 0.6 0.2 0.2
banzhafIndex<-function(A){
  bi=BanzhafConcept(A)
  return(calculatePowerIndex(bi))
}





logicRawBanzhafIndex=function(A){

  retVal=NULL
  bI=c()
  
  numberOfPlayers=log2(length(A)+1)
  bm=createBitMatrix(n=numberOfPlayers,A)
  # banzhafFactor=1/(2^(numberOfPlayers-1))
  
  for(i in 1:numberOfPlayers){
    #Get all coalitions K where player i takes part
    K=bm[bm[,i]==1,]
    
    #Get all coalition K \ {i}
    KwithoutI=K
    KwithoutI[,i]=0
    #set v({})=0
    KwithoutI[1,"cVal"]=0
    
    
    for(k in 2:nrow(K)){
      ix=indexCoalition(n=numberOfPlayers, S=getPlayersFromBMRow(KwithoutI[k,]))
      KwithoutI[k, "cVal"]=bm[ix,"cVal"]
    }
    sumMarginalContributions=sum(K[,"cVal"]-KwithoutI[,"cVal"])
    bI[i]=sumMarginalContributions#*banzhafFactor
  }
  
  return (bI)
}

#' @title BanzhafConcept
#' @noRd
#' @include PointSolutionConcept.R
#'# @exportClass BanzhafConcept

setClass(
  "BanzhafConcept",
  contains = "PointSolutionConcept"
)

#' @title Constructor for BanzhafConcept
#' @noRd
#' @template author/JA
#' @name BanzhafConcept
#' #@export
BanzhafConcept<-function(A){
  retBanzhafConcept=methods::new("BanzhafConcept",A)
  return(retBanzhafConcept)
}

#' @rdname calculatePowerIndex-methods
#' @aliases calculatePowerIndex,BanzhafConcept-method
setMethod(
  "calculatePowerIndex",
  signature="BanzhafConcept",
  definition=function(.Object){
    A<-.Object@A
    result=logicRawBanzhafIndex(A)
    return(result/sum(result))
  }
)

#' @name drawBanzhafValue
#' @title drawBanzhafValue for n players
#' @description drawBanzhafValue draws the Banzhaf Value for n players.
#' @aliases drawBanzhafValue
#' @export drawBanzhafValue
#' @template author/JA
#' @template author/JS
#' @template cites/PETERS_2015
#' @templateVar PETERS_2015_P p. 367 ff.
#' @template cites/CHAKRAVARTY_ET_AL_2015
#' @templateVar CHAKRAVARTY_ET_AL_2015_P p. 118 f.
#' @inheritParams CoopGameBaseParams
#' @inheritParams visualize
#' @examples
#' A<-cFuncQuotaVector(n=3,w=c(50,30,20),q=c(67))
#' drawBanzhafValue(A)
drawBanzhafValue<-function(A,holdOn=FALSE, colour = NA , label=TRUE, name = "Banzhaf value"){
  A=GameVector(A)
  bv=banzhafValue(A);
  visualize(A, pointsToDraw=bv, holdOn=holdOn, colour = colour , label=label, name = name)
}

##normalized banzhaf index
#' @name normalizedBanzhafIndex
#' @title normalizedBanzhafIndex
#' @description normalizedBanzhafIndex
#' @aliases normalizedBanzhafIndex
#' @export normalizedBanzhafIndex
#' @template author/JA
#' @template author/JS
#' @template cites/PETERS_2015
#' @templateVar PETERS_2015_P p. 367 ff.
#' @template cites/CHAKRAVARTY_ET_AL_2015
#' @templateVar CHAKRAVARTY_ET_AL_2015_P p. 118 f.
#' @inheritParams CoopGameBaseParams
#' @return The return value is a vector which contains the normalized Banzhaf index for each player.
#' @examples 
NULL
normalizedBanzhafIndex<-function(A){
  bc=BanzhafConcept(A)
  bidcs=calculatePowerIndex(bc)
  bidcs=bidcs/sum(bidcs)
  return(bidcs)
}

##nonNormalized banzhaf index
#' @name nonNormalizedBanzhafIndex
#' @title nonNormalizedBanzhafIndex
#' @description nonNormalizedBanzhafIndex
#' @aliases nonNormalizedBanzhafIndex
#' @export nonNormalizedBanzhafIndex
#' @template author/JA
#' @template author/JS
#' @template cites/PETERS_2015
#' @templateVar PETERS_2015_P p. 367 ff.
#' @template cites/CHAKRAVARTY_ET_AL_2015
#' @templateVar CHAKRAVARTY_ET_AL_2015_P p. 118 f.
#' @inheritParams CoopGameBaseParams
#' @return The return value is a vector which contains the nonnormalized Banzhaf index for each player.
#' @examples 
NULL
nonNormalizedBanzhafIndex<-function(A){
  bc=BanzhafConcept(A)
  facBv=2^(getNumberOfPlayers(A)-1)
  bidcs=calculatePowerIndex(bc)
  bidcs=bidcs/facBv
  return(bidcs)
}
